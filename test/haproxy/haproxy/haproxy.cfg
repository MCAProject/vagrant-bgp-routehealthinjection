global
  log stdout format raw local0

defaults
  timeout connect 10s
  timeout client 30s
  timeout server 30s
  mode http
  log global

frontend virutal-server
  bind *:80
  mode http
  option httplog
  # https://github.com/jcmoraisjr/modsecurity-spoa
  filter spoe engine modsecurity config /etc/haproxy/spoe-modsecurity.conf
  http-request deny if { var(txn.modsec.code) -m int gt 0 }
  default_backend backend-pod

backend backend-pod
  balance roundrobin
  mode http
  server-template k8s-nginx-pod 10 _http._tcp.headless-service.default.svc.cluster.local resolvers k8s_dns resolve-opts allow-dup-ip resolve-prefer ipv4 check

backend spoe-modsecurity
  mode tcp
  timeout connect 5s
  timeout server  5s
  server-template modsec-spoa1 10 _http._tcp.modsecurity-service.default.svc.cluster.local resolvers k8s_dns resolve-opts allow-dup-ip resolve-prefer ipv4 check

resolvers k8s_dns
  nameserver dns1 10.11.0.10:53
  hold valid 	       30s
  accepted_payload_size 8192

